<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Simple CDN</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
</head>
<body>
<div class="container" style="margin-top: 50px">
    <div style="display: flex; gap: 5px">
        <div class="mb-3">
            <label for="link-input" class="form-label">Link to file</label>
            <input style="width: 500px" class="form-control" id="link-input" placeholder="https://storage.com/file.bin">
        </div>
        <div style="padding-top: 32px">
            <button style="height: 38px" type="button" class="btn btn-secondary" onclick="startProcess()">Upload
            </button>
            <button style="height: 38px" type="button" class="btn btn-primary" disabled>Download</button>
        </div>
    </div>
    <div>
        <h3>Logs:</h3>
        <ul class="list-group" id="logs">
        </ul>
    </div>
</div>
<script>
    async function sendFileLink() {
        let link = document.querySelector("#link-input").value
        return await fetch("http://127.0.0.1/files/", {
            method: "POST",
            body: JSON.stringify({"link": link})
        })
    }

    function WebSocketConnect(fileName, originUrl) {
        let websocket = new WebSocket(`ws://127.0.0.1:8080/ws/?file_name=${fileName}&origin_url=${originUrl}`)
        websocket.onmessage = (event) => receiveMessage(event)
        return websocket
    }

    function receiveMessage(eventData) {
        let data = JSON.parse(eventData.data)
        let listItem = document.createElement("li");
        listItem.className = "list-group-item";
        let divContainer = document.createElement("div");
        divContainer.className = "d-flex justify-content-between";
        if(data["type"] === "saved"){
            let pElem1 = document.createElement("div")
            pElem1.className = "flex-item d-flex"
            pElem1.innerHTML = `<div class="badge bg-primary text-wrap" style="display: flex; align-items: center; margin-right: 5px">Saved</div><div>${data["server"]["name"]} ${data["server"]["zone"]} ${data["server"]["ip"]}</div>`

            let pElem2 = document.createElement("p")
            pElem2.style.margin = "0"
            pElem2.className = "flex-item"
            pElem2.textContent = `${data["duration"]}sec | ${data["time"]}`
            divContainer.appendChild(pElem1);
            divContainer.appendChild(pElem2);
        }
        else if(data["type"] === "replicated"){
            let pElem1 = document.createElement("p")
            pElem1.style.margin = "0"
            pElem1.className = "flex-item d-flex"
            pElem1.innerHTML = `<div class="badge bg-success text-wrap" style="display: flex; align-items: center; margin-right: 5px">Replicated</div><div>${data["from_server"]["name"]} ${data["from_server"]["zone"]} > ${data["to_server"]["name"]} ${data["to_server"]["zone"]} ${data["to_server"]["ip"]}</div>`

            let pElem2 = document.createElement("p")
            pElem2.style.margin = "0"
            pElem2.className = "flex-item"
            pElem2.textContent = `${data["duration"]}sec | ${data["time"]}`

            divContainer.appendChild(pElem1);
            divContainer.appendChild(pElem2);
            if(data["is_last_server"]){
                eventData.target.send("close")
                eventData.target.close()
            }
        }
        listItem.appendChild(divContainer)
        let myList = document.querySelector("#logs");
        let firstListItem = myList.firstChild;
        myList.insertBefore(listItem, firstListItem);
    }

    async function startProcess() {
        let downloadResponse = await sendFileLink()
        let downloadJson = await downloadResponse.json()
        let websocket = WebSocketConnect(downloadJson["file_name"], downloadJson["origin_url"])
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-HwwvtgBNo3bZJJLYd8oVXjrBZt8cqVSpeBNS5n7C8IVInixGAoxmnlMuBnhbgrkm"
        crossorigin="anonymous"></script>
</body>
</html>